<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">

    <script src="scripts/webgl-debug.js"></script>
    <script src="scripts/Math.js"></script>
    <script src="scripts/gl.js"></script>
    <script src="scripts/Shader.js"></script>
    <script src="scripts/RenderLoop.js"></script>
    <script src="scripts/Transform.js"></script>
    <script src="scripts/Model.js"></script>
    <script src="scripts/Primitives.js"></script>
    <script src="scripts/Camera.js"></script>
    <script src="scripts/ShaderExtras.js"></script>


    <script>
        let gl, gRenderLoop, gShader, gModel, gCamera, gCameraController, gSkyMap, gSkyMapShader;
        let gGridShader, gGridModel;


        window.addEventListener("load", function () {
            //Main Setup
            gl = GLInstance("glcanvas").fFitScreen(0.99, 0.99).fClear();

            gCamera = new Camera(gl);
            gCamera.transform.position.set(0, 1, 3);
            gCameraController = new CameraController(gl, gCamera);

            gl.fLoadTexture("tex001", document.getElementById("imageTexture"));

            gl.fLoadCubeMap("skybox01", [
                document.getElementById("cube01_right"), document.getElementById("cube01_left"),
                document.getElementById("cube01_top"), document.getElementById("cube01_bottom"),
                document.getElementById("cube01_back"), document.getElementById("cube01_front")
            ]);

            gl.fLoadCubeMap("skybox02", [
                document.getElementById("cube02_right"), document.getElementById("cube02_left"),
                document.getElementById("cube02_top"), document.getElementById("cube02_bottom"),
                document.getElementById("cube02_back"), document.getElementById("cube02_front")
            ]);


            //Setup grid
            gGridShader = new GridAxisShader(gl, gCamera.projectionMatrix);
            gGridModel = Primitives.GridAxis.createModel(gl, true);

            gShader = new TestShader(gl, gCamera.projectionMatrix)
                .setTexture(gl.mTextureCache["tex001"]);

            gModel = Primitives.Cube.createModel(gl);
            gModel.setPosition(0, 0.6, 0);

            gSkyMap = new Model(Primitives.Cube.createMesh(gl, "Skymap", 100, 100, 100, 0, 0, 0));
            gSkyMapShader = new SkyMapShader(
                gl,
                gCamera.projectionMatrix,
                gl.mTextureCache["skybox01"],
                gl.mTextureCache["skybox02"]
            );

            //Start Rendering
            gRenderLoop = new RenderLoop(onRender).start();
        });

        function onRender(deltaTime) {
            gCamera.updateViewMatrix();
            gl.fClear();

            gSkyMapShader.activate().preRender()
                .setCameraMatrix(gCamera.getTranslatelessMatrix())
                .setTime(performance.now())
                .renderModel(gSkyMap);

            gGridShader.activate()
                .setCameraMatrix(gCamera.viewMatrix)
                .renderModel(gGridModel.preRender());

            gShader.activate()
                .preRender()
                .setCameraMatrix(gCamera.viewMatrix)
                .setTime(performance.now())
                .renderModel(gModel.preRender())
        }


        class SkyMapShader extends Shader{
            constructor(gl, projectionMatrix, day, night){
                let vertSrc = ShaderUtil.domShaderSrc("skyVertexShader"),
                    fragSrc = ShaderUtil.domShaderSrc("skyFragmentShader");
                super(gl, vertSrc, fragSrc);

                this.uniformLocation.time = gl.getUniformLocation(this.program, "uTime");
                this.uniformLocation.dayTexture = gl.getUniformLocation(this.program, "uDayTexture");
                this.uniformLocation.nightTexture = gl.getUniformLocation(this.program, "uNightTexture");

                this.setPerspective(projectionMatrix);
                this.textureDay = day;
                this.textureNight = night;
                gl.useProgram(null);
            }

            setTime(t){
                this.gl.uniform1f(this.uniformLocation.time, t);
                return this;
            }

            preRender() {
                this.gl.activeTexture(this.gl.TEXTURE0);
                this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP, this.textureDay);
                this.gl.uniform1i(this.uniformLocation.dayTexture, 0);

                this.gl.activeTexture(this.gl.TEXTURE1);
                this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP, this.textureNight);
                this.gl.uniform1i(this.uniformLocation.nightTexture, 1);

                return this;
            }

        }

        class TestShader extends Shader {
            constructor(gl, projectionMatrix) {
                let vertSrc = ShaderUtil.domShaderSrc("vertex_shader"),
                    fragSrc = ShaderUtil.domShaderSrc("fragment_shader");
                super(gl, vertSrc, fragSrc);

                this.uniformLocation.time = gl.getUniformLocation(this.program, "uTime");

                let uColor = gl.getUniformLocation(this.program, "uColor");
                gl.uniform3fv(uColor, new Float32Array(GlUtil.toRgbArray("#FF0000", "00FF00", "0000FF", "909090", "C0C0C0", "404040")));

                this.setPerspective(projectionMatrix);
                this.mainTexture = -1;
                gl.useProgram(null);
            }

            setTime(time) {
                this.gl.uniform1f(this.uniformLocation.time, time);
                return this;
            }

            setTexture(textureId) {
                this.mainTexture = textureId;
                return this;
            }

            //override
            preRender() {
                this.gl.activeTexture(this.gl.TEXTURE0);
                this.gl.bindTexture(this.gl.TEXTURE_2D, this.mainTexture);
                this.gl.uniform1i(this.uniformLocation.mainTexture, 0);

                return this;
            }
        }
    </script>
</head>
<body>
<div>
    <canvas id="glcanvas"></canvas>
</div>

<img src="resources/textures/UV_Grid_Lrg.jpg" id="imageTexture" alt="" style="display:none;">

<img src="resources/textures/cubemaps/miramar_back.png" id="cube01_back" style="display:none;">
<img src="resources/textures/cubemaps/miramar_front.png" id="cube01_front" style="display:none;">
<img src="resources/textures/cubemaps/miramar_bottom.png" id="cube01_bottom" style="display:none;">
<img src="resources/textures/cubemaps/miramar_left.png" id="cube01_left" style="display:none;">
<img src="resources/textures/cubemaps/miramar_right.png" id="cube01_right" style="display:none;">
<img src="resources/textures/cubemaps/miramar_top.png" id="cube01_top" style="display:none;">

<img src="resources/textures/cubemaps/grimmnight_back.png" id="cube02_back" style="display:none;">
<img src="resources/textures/cubemaps/grimmnight_front.png" id="cube02_front" style="display:none;">
<img src="resources/textures/cubemaps/grimmnight_bottom.png" id="cube02_bottom" style="display:none;">
<img src="resources/textures/cubemaps/grimmnight_left.png" id="cube02_left" style="display:none;">
<img src="resources/textures/cubemaps/grimmnight_right.png" id="cube02_right" style="display:none;">
<img src="resources/textures/cubemaps/grimmnight_top.png" id="cube02_top" style="display:none;">


<script id="vertex_shader" type="x-shader/x-vertex">#version 300 es
in vec4 aPosition;//w component is index for uColor
in vec3 aNormal;
in vec2 aUv;

uniform mat4 uProjectionMatrix;
uniform mat4 uCameraMatrix;
uniform mat4 uModelViewMatrix;
uniform float uTime;
uniform vec3 uColor[6];

out highp vec2 textureCoordinates;
out lowp vec4 color;

vec3 warp(vec3 p){
    //    return p+0.2 * abs(cos(uTime*0.002)) * aNormal;
    return p+0.5*abs(cos(uTime*0.003 + p.y*2.0 + p.x*2.0 + p.z))*aNormal;
}

void main(void){
    textureCoordinates = aUv;
    color = vec4(uColor[int(aPosition.w)], 1.0);
    gl_Position = uProjectionMatrix * uCameraMatrix * uModelViewMatrix * vec4(warp(aPosition.xyz), 1.0);
}
</script>

<script id="fragment_shader" type="x-shader/x-fragment">#version 300 es
precision mediump float;

in highp vec2 textureCoordinates;
in lowp vec4 color;
uniform sampler2D uMainTexture;

out vec4 finalColor;

void main(void){
    vec4 tex = texture(uMainTexture, textureCoordinates);
    if (tex.a < 0.5){
        discard;
    }
    finalColor = mix(color, tex, 0.8f);
}
</script>





<script id="skyVertexShader" type="x-shader/x-vertex">#version 300 es
in vec4 aPosition;//w component is index for uColor
in vec2 aUv;

uniform mat4 uProjectionMatrix;
uniform mat4 uCameraMatrix;
uniform mat4 uModelViewMatrix;

out highp vec3 textureCoordinates;

void main(void){
    textureCoordinates = aPosition.xyz;
    gl_Position = uProjectionMatrix * uCameraMatrix * uModelViewMatrix * vec4(aPosition.xyz, 1.0);
}
</script>

<script id="skyFragmentShader" type="x-shader/x-fragment">#version 300 es
precision mediump float;

in highp vec3 textureCoordinates;
uniform samplerCube uDayTexture;
uniform samplerCube uNightTexture;
uniform float uTime;

out vec4 finalColor;

void main(void){
    finalColor = mix( texture(uDayTexture, textureCoordinates), texture(uNightTexture,textureCoordinates),abs(sin(uTime * 0.0001)));
}
</script>


</body>
</html>
