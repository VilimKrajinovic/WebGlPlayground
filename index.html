<!DOCTYPE html>
<html>
<head>

    <link rel="stylesheet" href="style.css">

    <script src="scripts/webgl-debug.js"></script>
    <script src="scripts/Math.js"></script>
    <script src="scripts/gl.js"></script>
    <script src="scripts/Shader.js"></script>
    <script src="scripts/RenderLoop.js"></script>
    <script src="scripts/Transform.js"></script>
    <script src="scripts/Model.js"></script>
    <script src="scripts/Primitives.js"></script>
    <script src="scripts/Camera.js"></script>


    <script>
        let gl, gRenderLoop, gShader, gModel, gCamera, gCameraController;

        window.addEventListener("load", function () {
            //Main Setup
            gl = GLInstance("glcanvas").fSetSize(500, 500).fClear();

            gCamera = new Camera(gl);
            gCamera.transform.position.set(0, 0, 3);
            gCameraController = new CameraController(gl, gCamera);


            gShader = new TestShader(gl, [0.8, 0.8, 0.8, 1, 0, 0, 0, 1, 0, 0, 0, 1]); //Gray,Red,Green,Blue
            gShader.activate().setPerspective(gCamera.projectionMatrix).deactivate();

            //Setup our model
            gModel = new Model(Primitives.GridAxis.createMesh(gl))
                .setScale(0.5, 0.5, 0.5)
                .setRotation(0, 0, 0)
                .setPosition(0, 0, 0);

            //Start Rendering
            gRenderLoop = new RenderLoop(onRender).start();
        });

        function onRender(deltaTime) {
            gCamera.updateViewMatrix();
            gl.fClear();

            gShader.activate()
                .setCameraMatrix(gCamera.viewMatrix)
                .renderModel(gModel.preRender());
        }

        class TestShader extends Shader {
            constructor(gl, aryColor) {
                let vertSrc = ShaderUtil.domShaderSrc("vertex_shader"),
                    fragSrc = ShaderUtil.domShaderSrc("fragment_shader");
                super(gl, vertSrc, fragSrc);

                var uColor = gl.getUniformLocation(this.program, "uColor");
                gl.uniform3fv(uColor, aryColor);

                gl.useProgram(null);
            }
        }
    </script>
</head>
<body>
<div>
    <canvas id="glcanvas"></canvas>
</div>

<script id="vertex_shader" type="x-shader/x-vertex">#version 300 es
in vec3 aPosition;
layout(location=4) in float aColour;

uniform mat4 uPerspectiveMatrix;
uniform mat4 uCameraMatrix;
uniform mat4 uModelViewMatrix;
uniform vec3 uColor[4];//Color Array

out lowp vec4 color;//Color to send to fragment shader.

void main(void){
    color = vec4(uColor[int(aColour)], 1.0);//Using the 4th float as a color index.
    gl_Position = uPerspectiveMatrix * uCameraMatrix *  uModelViewMatrix * vec4(aPosition, 1.0);
}
</script>

<script id="fragment_shader" type="x-shader/x-fragment">#version 300 es
precision mediump float;

in vec4 color;
out vec4 finalColor;

void main(void){ finalColor = color; }
</script>

</body>
</html>
