<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">

    <script src="scripts/webgl-debug.js"></script>
    <script src="scripts/Math.js"></script>
    <script src="scripts/gl.js"></script>
    <script src="scripts/Shader.js"></script>
    <script src="scripts/RenderLoop.js"></script>
    <script src="scripts/Transform.js"></script>
    <script src="scripts/Model.js"></script>
    <script src="scripts/Primitives.js"></script>
    <script src="scripts/Camera.js"></script>
    <script src="scripts/ShaderExtras.js"></script>


    <script>
        let gl, gRenderLoop, gShader, gModel, gCamera, gCameraController;
        let gGridShader, gGridModel;


        window.addEventListener("load", function () {
            //Main Setup
            gl = GLInstance("glcanvas").fFitScreen(0.99, 0.99).fClear();

            gCamera = new Camera(gl);
            gCamera.transform.position.set(0, 1, 3);
            gCameraController = new CameraController(gl, gCamera);

            gl.fLoadTexture("tex001", document.getElementById("imageTexture"));


            //Setup grid
            gGridShader = new GridAxisShader(gl, gCamera.projectionMatrix);
            gGridModel = Primitives.GridAxis.createModel(gl, true);

            gShader = new TestShader(gl, gCamera.projectionMatrix)
                .setTexture(gl.mTextureCache["tex001"]);

            gModel = Primitives.MultiQuad.createModel(gl);

            //Start Rendering
            gRenderLoop = new RenderLoop(onRender).start();
        });

        function onRender(deltaTime) {
            gCamera.updateViewMatrix();
            gl.fClear();

            gGridShader.activate()
                .setCameraMatrix(gCamera.viewMatrix)
                .renderModel(gGridModel.preRender());

            gShader.activate()
                .preRender()
                .setCameraMatrix(gCamera.viewMatrix)
                .renderModel(gModel.preRender())
        }

        class TestShader extends Shader {
            constructor(gl, projectionMatrix) {
                let vertSrc = ShaderUtil.domShaderSrc("vertex_shader"),
                    fragSrc = ShaderUtil.domShaderSrc("fragment_shader");
                super(gl, vertSrc, fragSrc);

                this.setPerspective(projectionMatrix);
                this.mainTexture = -1;

                gl.useProgram(null);
            }

            setTexture(textureId) {
                this.mainTexture = textureId;
                return this;
            }

            //override
            preRender() {
                this.gl.activeTexture(this.gl.TEXTURE0);
                this.gl.bindTexture(this.gl.TEXTURE_2D, this.mainTexture);
                this.gl.uniform1i(this.uniformLocation.mainTexture, 0);

                return this;
            }
        }
    </script>
</head>
<body>
<div>
    <canvas id="glcanvas"></canvas>
</div>

<img src="resources/textures/grassTexture.png" id="imageTexture" alt="" style="display:none;">

<script id="vertex_shader" type="x-shader/x-vertex">#version 300 es
in vec3 aPosition;
in vec2 aUv;

uniform mat4 uProjectionMatrix;
uniform mat4 uCameraMatrix;
uniform mat4 uModelViewMatrix;

out highp vec2 textureCoordinates;

void main(void){
    textureCoordinates = aUv;
    gl_Position = uProjectionMatrix * uCameraMatrix *  uModelViewMatrix * vec4(aPosition, 1.0);
}
</script>

<script id="fragment_shader" type="x-shader/x-fragment">#version 300 es
precision mediump float;

in highp vec2 textureCoordinates;
uniform sampler2D uMainTexture;

out vec4 finalColor;

void main(void){
    vec4 tex = texture(uMainTexture, textureCoordinates);
    if(tex.a < 0.5){
        discard;
    }
    finalColor = tex;
}
</script>

</body>
</html>
