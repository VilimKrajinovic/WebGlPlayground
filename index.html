<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">

    <script src="scripts/webgl-debug.js"></script>
    <script src="scripts/Math.js"></script>
    <script src="scripts/gl.js"></script>
    <script src="scripts/Shader.js"></script>
    <script src="scripts/RenderLoop.js"></script>
    <script src="scripts/Transform.js"></script>
    <script src="scripts/Model.js"></script>
    <script src="scripts/Primitives.js"></script>
    <script src="scripts/Camera.js"></script>
    <script src="scripts/ShaderExtras.js"></script>


    <script>
        let gl, gRenderLoop, gShader, gModel, gCamera, gCameraController;
        let gGridShader, gGridModel;
        let gModelQuad;


        window.addEventListener("load", function () {
            //Main Setup
            gl = GLInstance("glcanvas").fFitScreen(0.99, 0.99).fClear();

            gCamera = new Camera(gl);
            gCamera.transform.position.set(0, 1, 3);
            gCameraController = new CameraController(gl, gCamera);

            //Setup grid
            gGridShader = new GridAxisShader(gl, gCamera.projectionMatrix);
            gGridModel = Primitives.GridAxis.createModel(gl, true);

            gShader = new TestShader(gl, gCamera.projectionMatrix);
            gModel = Primitives.Quad.createModel(gl);
            gModel.setPosition(0, 1, 0).setScale(0.2, 0.2, 0.2);

            gModelQuad = new Model(gl.mMeshCache["Quad"]);

            //Start Rendering
            gRenderLoop = new RenderLoop(onRender).start();
        });

        function onRender(deltaTime) {
            gCamera.updateViewMatrix();
            gl.fClear();

            gGridShader.activate()
                .setCameraMatrix(gCamera.viewMatrix)
                .renderModel(gGridModel.preRender());

            gShader.activate()
                .setCameraMatrix(gCamera.viewMatrix)
                .renderModel(gModel.preRender())
                .renderModel(gModelQuad.preRender());
        }

        class TestShader extends Shader {
            constructor(gl, projectionMatrix) {
                let vertSrc = ShaderUtil.domShaderSrc("vertex_shader"),
                    fragSrc = ShaderUtil.domShaderSrc("fragment_shader");
                super(gl, vertSrc, fragSrc);

                this.setPerspective(projectionMatrix);

                gl.useProgram(null);
            }
        }
    </script>
</head>
<body>
<div>
    <canvas id="glcanvas"></canvas>
</div>

<script id="vertex_shader" type="x-shader/x-vertex">#version 300 es
in vec3 aPosition;
in vec2 aUv;

uniform mat4 uProjectionMatrix;
uniform mat4 uCameraMatrix;
uniform mat4 uModelViewMatrix;
uniform vec3 uColor[4];//Color Array

out vec2 uv;

void main(void){
    uv=aUv;
    gl_Position = uProjectionMatrix * uCameraMatrix *  uModelViewMatrix * vec4(aPosition, 1.0);
}
</script>

<script id="fragment_shader" type="x-shader/x-fragment">#version 300 es
precision mediump float;

in vec2 uv;
out vec4 finalColor;

void main(void){
    float c = (uv.x <= 0.1 || uv.x >= 0.9 || uv.y<= 0.1 || uv.y>=0.9)? 0.0 : 1.0;
    finalColor = vec4(c, c, c, 1.0-c);
}
</script>

</body>
</html>
