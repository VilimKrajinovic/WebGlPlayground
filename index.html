<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="scripts/gl.js"></script>
    <script src="scripts/Shader.js"></script>
    <script src="scripts/RenderLoop.js"></script>
    <script src="scripts/Model.js"></script>

    <script>
        let gl;
        let gVerticesCount = 0;
        let uPointSizeLocation = -1;
        let uAngle = 0;
        let gRenderLoop;
        let gShader = null;
        let gModel = null;

        window.addEventListener("load", function () {
            gl = GLInstance("glcanvas").fSetSize(500, 500).fClear();

            // Setup shaders
            gShader = new TestShader(gl);

            // Setup data buffers

            let mesh = gl.fCreateMeshVAO("dots", null, [0,0,0]);
            mesh.drawMode = gl.POINTS;

            gModel = new Model(mesh);

            // Setup drawing
            gRenderLoop = new RenderLoop(onRender, 30.0).start();
        });

        let gPointSize = 0;
        let gPointSizeStep = 3;
        let gAngle = 0;
        let gAngleStep = (Math.PI / 180.0) * 90;


        function onRender(deltaTime) {
            gl.fClear();

            gShader.activate().set(
                (Math.sin((gPointSize += gPointSizeStep * deltaTime)) * 10.0) +30.0,
                (gAngle += gAngleStep * deltaTime)
            ).renderModel(gModel);
        }

        class TestShader extends Shader {
            constructor(gl) {
                let vertexSource = ShaderUtil.domShaderSrc("vertexShader");
                let fragmentSource = ShaderUtil.domShaderSrc("fragmentShader");

                super(gl, vertexSource, fragmentSource);

                this.uniformLocation.uPointSize = gl.getUniformLocation(this.program, "uPointSize");
                this.uniformLocation.uAngle = gl.getUniformLocation(this.program, "uAngle");

                gl.useProgram(null);
            }

            set(size, angle) {
                this.gl.uniform1f(this.uniformLocation.uPointSize, size);
                this.gl.uniform1f(this.uniformLocation.uAngle, angle);
                return this;
            };
        }
    </script>
    <link rel="stylesheet" href="style.css">

</head>
[
<body>

<div>
    <canvas id="glcanvas"></canvas>
</div>


<!--VERTEX SHADER-->
<script id="vertexShader" type="x-shader/x-vertex">#version 300 es
in vec3 aPosition;

uniform mediump float uPointSize;
uniform float uAngle;

out vec3 size;

void main(void){
    gl_PointSize = uPointSize;
    size = vec3(uPointSize);
    gl_Position = vec4(cos(uAngle) * 0.8 + aPosition.x, sin(uAngle) * 0.8 + aPosition.y, aPosition.z, 1.0);
}
</script>

<!--FRAGMENT SHADER-->
<script id="fragmentShader" type="x-shader/x-fragment">#version 300 es
precision mediump float;

uniform mediump float uPointSize;
in vec3 size;
out vec4 finalColour;

void main(void){
    float colour = (40.0 - uPointSize)/ 20.0;
    finalColour = vec4(colour, colour, colour, 1.0);
}
</script>

</body>
</html>